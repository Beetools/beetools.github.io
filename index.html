<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CineTalk ‚Äî Realtime Voice</title>
<meta name="theme-color" content="#0d0f14" />
<meta name="description" content="CineTalk - Conversa√ß√£o em tempo real com OpenAI Realtime API" />
<style>
  /* ====== Reset & Base ====== */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg-0:#0b0d12; --bg-1:#0f1320; --bg-2:#131a2a;
    --ink:#eaf6ff; --muted:#9fb3c8; --brand:#10a37f; --brand-2:#1a7f64; --warn:#f59e0b; --err:#ef4444;
    --card:rgba(255,255,255,.04); --glass:rgba(255,255,255,.06);
    --bd:rgba(255,255,255,.08); --bd-2:rgba(255,255,255,.12);
    --radius:18px; --radius-sm:12px; --shadow:0 10px 40px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  body{
    font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    background: radial-gradient(1200px 600px at 20% -10%, #16233c, transparent),
                radial-gradient(1200px 800px at 120% 0%, #1b0f3c, transparent),
                linear-gradient(135deg, #0b0d12 0%, #0f1320 50%, #131a2a 100%);
    color:var(--ink);
    line-height:1.6;
    padding:16px;
  }
  a{color:var(--brand);text-decoration:none}
  .container{max-width:1100px;margin:0 auto}

  /* ====== Header sticky ====== */
  .appbar{
    position:sticky;top:10px;z-index:20;
    display:flex;align-items:center;gap:14px;justify-content:space-between;
    padding:14px 18px;border-radius:16px;background:var(--glass);backdrop-filter: blur(12px);
    border:1px solid var(--bd);
    box-shadow:var(--shadow);
    margin-bottom:16px;
  }
  .brand{
    display:flex;align-items:center;gap:12px;
  }
  .brand h1{
    font-size:1.6rem;font-weight:800;
    background:linear-gradient(135deg, var(--brand), #26d07c);
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    letter-spacing:0.2px;text-shadow:0 0 24px rgba(16,163,127,.35);
    white-space:nowrap;
  }
  .badge{font-size:.8rem;font-weight:700;padding:6px 12px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 4px 18px rgba(16,163,127,.45)}
  .conn{
    display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);
    background:var(--card)
  }
  .dot{width:10px;height:10px;border-radius:50%;background:#6b7280;box-shadow:0 0 0 0 rgba(16,163,127,.0)}
  .dot.on{background:var(--brand);animation:dotPulse 2s infinite;box-shadow:0 0 10px var(--brand)}
  @keyframes dotPulse{0%,100%{opacity:1}50%{opacity:.5}}

  /* ====== Panels ====== */
  .panel{
    background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); padding:20px; backdrop-filter: blur(8px); box-shadow:var(--shadow); margin-bottom:16px;
  }
  .panel h2{font-size:1.05rem;color:var(--muted);margin-bottom:12px;letter-spacing:.2px}

  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid.cols-2{ grid-template-columns:1.2fr .8fr } }

  /* ====== Inputs ====== */
  .field{display:grid; gap:8px}
  .label{font-weight:700;color:var(--brand);font-size:.95rem}
  .input, .select{
    width:100%;padding:14px 14px;border-radius:12px;border:2px solid rgba(16,163,127,.28);
    background:rgba(255,255,255,.04);color:var(--ink);outline:none;transition:.25s;
    font-size:1rem
  }
  .input::placeholder{color:#98a9bd}
  .input:focus, .select:focus{border-color:var(--brand); box-shadow:0 0 16px rgba(16,163,127,.25)}
  .muted{color:var(--muted);font-size:.9rem}

  /* ====== Chat ====== */
  .chat{height:520px;overflow:auto;padding:14px;border-radius:16px;background:var(--glass);border:1px solid var(--bd)}
  .msg{margin:12px 0; padding:14px 16px; border-radius:14px; position:relative; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .msg.user{background:linear-gradient(135deg,#667eea,#764ba2); margin-left:15%; border-bottom-right-radius:6px}
  .msg.assistant{background:linear-gradient(135deg,var(--brand),var(--brand-2)); margin-right:15%; border-bottom-left-radius:6px}
  .msg.system{background:rgba(255,255,255,.08); color:#cbd5e1; font-style:italic; border-left:3px solid var(--brand); margin:10px 5%}
  .time{position:absolute; bottom:-18px; right:12px; font-size:.72rem; color:#90a4b8; opacity:.85}
  .sticky-tip{font-size:.95rem;color:#c7d6e8;margin-bottom:6px}

  /* ====== Controls ====== */
  .controls{
    display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; padding:18px; border-radius:16px; background:var(--glass); border:1px solid var(--bd)
  }
  .ptt{
    width:140px;height:140px;border-radius:999px;border:none;cursor:pointer;font-size:2.2rem;
    display:flex;align-items:center;justify-content:center;transition: transform .16s;
    background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; box-shadow:0 14px 36px rgba(16,163,127,.45)
  }
  .ptt:hover{transform:scale(1.05)}
  .ptt.listening{background:linear-gradient(135deg,var(--warn),#f59e0b); animation:pttPulse 1.6s infinite}
  .ptt.stop{background:linear-gradient(135deg,#ef4444,#dc2626)}
  @keyframes pttPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

  .status{
    text-align:center; font-weight:700; padding:12px 14px; border-radius:12px;
    background:rgba(255,255,255,.05); border:2px solid transparent; width:100%
  }
  .status.ok{background:rgba(16,163,127,.15); border-color:var(--brand)}
  .status.err{background:rgba(239,68,68,.15); border-color:#ef4444}

  .meter{height:56px; display:flex; gap:6px; align-items:flex-end; justify-content:center}
  .bar{width:6px; background:linear-gradient(to top, var(--brand), #26d07c); border-radius:3px; height:8px}

  /* ====== Footer actions ====== */
  .row{display:flex; gap:10px}
  .btn{
    border:none; border-radius:10px; padding:12px 14px; font-weight:700; cursor:pointer;
    background:rgba(255,255,255,.06); color:#e8f3ff; border:1px solid var(--bd-2); transition:.2s
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2)); border:none}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);border:none}
  .btn.ghost{background:transparent}

  /* Toasts */
  .toast-wrap{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:99}
  .toast{
    background:rgba(14,18,26,.9); color:#e9f4ff; padding:12px 14px; border:1px solid var(--bd);
    border-radius:12px; box-shadow:var(--shadow); min-width:240px; font-size:.95rem
  }

  /* Suggestions */
  .suggestions{display:grid; gap:10px}
  .sugg{background:rgba(255,255,255,.05); border:1px solid var(--bd); padding:12px 14px; border-radius:12px; cursor:pointer}
  .sugg:hover{background:rgba(16,163,127,.12); border-color:var(--brand); transform:translateX(6px); transition:.18s}

  @media (max-width:780px){
    .grid.cols-2{grid-template-columns:1fr}
    .ptt{width:110px;height:110px}
  }
</style>
</head>
<body>
<div class="container">

  <!-- Top bar -->
  <div class="appbar">
    <div class="brand">
      <div style="font-size:1.6rem">üé¨</div>
      <h1>CineTalk</h1>
      <span class="badge">‚ö° Realtime</span>
    </div>
    <div class="conn"><span class="dot" id="dot"></span><span id="connTxt">Desconectado</span></div>
  </div>

  <!-- Grid: chat | config -->
  <div class="grid cols-2">
    <!-- Left: chat -->
    <section class="panel">
      <h2>Chat</h2>
      <div class="sticky-tip">Dica: segure o bot√£o para falar. Soltou? Eu respondo. Voc√™ tamb√©m pode enviar texto üëá</div>
      <div id="chat" class="chat" aria-live="polite"></div>

      <div style="margin-top:12px" class="row">
        <input id="textInput" class="input" placeholder="Digite uma mensagem (Enter para enviar)" />
        <button id="sendBtn" class="btn primary">Enviar</button>
        <button id="copyBtn" class="btn">Copiar resposta</button>
        <button id="clearBtn" class="btn danger">Limpar</button>
      </div>
    </section>

    <!-- Right: config & controls -->
    <aside class="panel">
      <h2>Configura√ß√£o</h2>
      <div class="field">
        <label class="label" for="key">üîë OpenAI API Key (dev/teste)</label>
        <input id="key" class="input" type="password" placeholder="sk-..." autocomplete="off" />
        <small class="muted">‚ö†Ô∏è Produ√ß√£o segura exige <strong>token ef√™mero</strong> gerado no seu backend (nunca exponha a key no browser).</small>
      </div>

      <div class="grid" style="margin-top:10px">
        <div class="field">
          <label class="label" for="voice">üéôÔ∏è Voz</label>
          <select id="voice" class="select">
            <option value="alloy">Alloy</option>
            <option value="echo">Echo</option>
            <option value="shimmer">Shimmer</option>
            <option value="ash">Ash</option>
            <option value="ballad">Ballad</option>
            <option value="coral">Coral</option>
          </select>
        </div>
        <div class="field">
          <label class="label" for="model">üß† Modelo</label>
          <select id="model" class="select">
            <option value="gpt-4o-realtime-preview-2024-10-01" selected>gpt-4o-realtime-preview-2024-10-01</option>
          </select>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Controles de Voz</h2>
        <div class="controls">
          <button id="ptt" class="ptt" title="Segure para falar">üé§</button>
          <div id="status" class="status">Configure sua chave e segure o bot√£o para falar</div>
          <div id="meter" class="meter" aria-hidden="true">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Perguntas Sugeridas</h2>
        <div class="suggestions" id="suggs">
          <div class="sugg" data-text="Quais s√£o os melhores filmes de fic√ß√£o cient√≠fica dos anos 80?">üöÄ Sci-fi anos 80</div>
          <div class="sugg" data-text="Me recomende s√©ries de suspense na Netflix">üîç Suspense na Netflix</div>
          <div class="sugg" data-text="Conte sobre a filmografia do Quentin Tarantino">üé¨ Filmografia Tarantino</div>
          <div class="sugg" data-text="Quais s√©ries s√£o boas para assistir em fam√≠lia?">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ S√©ries para fam√≠lia</div>
          <div class="sugg" data-text="Explique o que √© cinema noir">üïµÔ∏è O que √© cinema noir</div>
          <div class="sugg" data-text="Recomende anima√ß√µes premiadas recentes">üé® Anima√ß√µes premiadas</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Info -->
  <section class="panel">
    <h2>‚ÑπÔ∏è Como funciona</h2>
    <p class="muted">
      Este demo usa WebSocket da OpenAI Realtime API (voz <em>bidirecional</em> com VAD no servidor).
      Para produ√ß√£o, gere um <strong>token ef√™mero</strong> no backend e troque o subprotocolo de autentica√ß√£o.
    </p>
  </section>

</div>

<!-- Toasts -->
<div id="toasts" class="toast-wrap"></div>

<script>
  // ===================== State =====================
  const el = (id)=>document.getElementById(id);
  const chat = el('chat'); const statusEl = el('status'); const dot = el('dot'); const connTxt = el('connTxt');
  const ptt = el('ptt'); const voiceSel = el('voice'); const modelSel = el('model');
  const keyInput = el('key'); const textInput = el('textInput'); const sendBtn = el('sendBtn');
  const clearBtn = el('clearBtn'); const copyBtn = el('copyBtn'); const toasts = el('toasts');
  const meter = el('meter'); const suggs = el('suggs');

  let ws=null, connected=false, apiKey='', selectedVoice='alloy', model=modelSel.value;
  let audioCtx=null, stream=null, procNode=null, analyser=null, rafId=null;
  let outgoingEnabled=false;
  let audioQueue=[]; let playing=false; let currentAssistantDiv=null; let lastAssistantText='';
  const SAMPLE_RATE = 24000;

  const systemPrompt = `Voc√™ √© CineTalk, um assistente de cinema.
- Responda em 2-4 frases, voz natural e objetiva.
- Sempre que poss√≠vel, pergunte uma prefer√™ncia do usu√°rio para refinar recomenda√ß√µes.
- Especialista em filmes cl√°ssicos, lan√ßamentos, festivais e streaming.`;

  // ===================== Helpers =====================
  const toast=(msg)=>{ const d=document.createElement('div'); d.className='toast'; d.textContent=msg; toasts.appendChild(d); setTimeout(()=>{ d.style.opacity='0'; setTimeout(()=>d.remove(),300)},2200) }
  const stamp=()=> new Date().toLocaleTimeString();

  function addMsg(role, text){
    const m=document.createElement('div');
    m.className=`msg ${role}`;
    m.textContent=text;
    const t=document.createElement('div'); t.className='time'; t.textContent=stamp(); m.appendChild(t);
    chat.appendChild(m); chat.scrollTop=chat.scrollHeight;
    if(role==='assistant') lastAssistantText=text;
    const all=chat.querySelectorAll('.msg'); if(all.length>60) all[0].remove();
    return m;
  }

  function updateAssistant(delta){
    if(!currentAssistantDiv){
      currentAssistantDiv=addMsg('assistant', delta||'');
    } else {
      currentAssistantDiv.firstChild.nodeValue += (delta||'');
    }
    chat.scrollTop=chat.scrollHeight;
  }
  function finalizeAssistant(){ currentAssistantDiv=null }

  function setStatus(txt, ok=false, err=false){
    statusEl.textContent = txt;
    statusEl.className='status'+(ok?' ok':'')+(err?' err':'');
  }
  function setConn(on){
    connected=on;
    connTxt.textContent = on?'Conectado':'Desconectado';
    dot.classList.toggle('on', on);
    ptt.classList.toggle('stop', on);
  }

  // ===================== Audio visuals =====================
  function startMeter(){
    if(!analyser) return;
    const bars=[...meter.querySelectorAll('.bar')];
    function loop(){
      const arr=new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(arr);
      const step=Math.floor(arr.length/bars.length);
      bars.forEach((b,i)=>{
        const slice=arr.slice(i*step,(i+1)*step);
        const avg=slice.reduce((a,c)=>a+c,0)/slice.length || 0;
        const h=Math.max(6, Math.min(52, (avg/255)*56));
        b.style.height=`${h}px`;
      });
      rafId=requestAnimationFrame(loop);
    }
    loop();
  }
  function stopMeter(){ if(rafId){ cancelAnimationFrame(rafId); rafId=null } }

  // ===================== Audio I/O =====================
  function f32ToPCM16(f){
    const out=new Int16Array(f.length);
    for(let i=0;i<f.length;i++){ const s=Math.max(-1,Math.min(1,f[i])); out[i]=s<0? s*0x8000 : s*0x7FFF }
    return out;
  }
  const b64 = {
    fromAB:(buf)=>{ let bin=''; const bytes=new Uint8Array(buf); for(let i=0;i<bytes.byteLength;i++) bin+=String.fromCharCode(bytes[i]); return btoa(bin) },
    toAB:(base64)=>{ const bin=atob(base64); const len=bin.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++) bytes[i]=bin.charCodeAt(i); return bytes.buffer }
  };

  function playNext(){
    if(playing) return;
    const chunk=audioQueue.shift();
    if(!chunk){ playing=false; return }
    playing=true;
    setStatus('üîä Assistente falando...', true);
    const buf=audioCtx.createBuffer(1, chunk.length, SAMPLE_RATE);
    buf.getChannelData(0).set(chunk);
    const src=audioCtx.createBufferSource(); src.buffer=buf; src.connect(audioCtx.destination);
    src.onended=()=>{ playing=false; if(audioQueue.length){ playNext() } else { setStatus('üé§ Segure para falar', true) } };
    src.start();
  }

  function queueAudio(base64){
    const ab=b64.toAB(base64);
    const i16=new Int16Array(ab);
    const f32=new Float32Array(i16.length);
    for(let i=0;i<i16.length;i++){ f32[i]= i16[i] / (i16[i]<0?0x8000:0x7FFF) }
    if(audioQueue.length>50) audioQueue.shift();
    audioQueue.push(f32);
    if(!playing) playNext();
  }

  // ===================== WebSocket events =====================
  function onWSMessage(ev){
    const msg=JSON.parse(ev.data);
    switch(msg.type){
      case 'session.created':
      case 'session.updated':
        break;
      case 'input_audio_buffer.speech_started':
        ptt.classList.add('listening'); setStatus('üé§ Ouvindo...', true); break;
      case 'input_audio_buffer.speech_stopped':
        ptt.classList.remove('listening'); setStatus('ü§î Processando...', true); break;
      case 'conversation.item.input_audio_transcription.completed':
        if(msg.transcript) addMsg('user', msg.transcript);
        break;
      case 'response.audio_transcript.delta':
        updateAssistant(msg.delta); break;
      case 'response.audio.delta':
        if(msg.delta) queueAudio(msg.delta); break;
      case 'response.done':
        finalizeAssistant(); setStatus('üé§ Segure para falar', true); break;
      case 'error':
        toast(`Erro: ${msg.error?.message||'desconhecido'}`); setStatus('‚ùå Erro', false, true); break;
    }
  }

  // ===================== Connect / Disconnect =====================
  async function connectWS(){
    if(!apiKey){ toast('Informe sua API key'); keyInput.focus(); return }
    try{
      setStatus('üîÑ Conectando...');
      stream = await navigator.mediaDevices.getUserMedia({
        audio:{ echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:SAMPLE_RATE, channelCount:1 }
      });
      audioCtx = new (window.AudioContext||window.webkitAudioContext)({ sampleRate:SAMPLE_RATE });

      const srcNode=audioCtx.createMediaStreamSource(stream);
      analyser=audioCtx.createAnalyser(); analyser.fftSize=1024; srcNode.connect(analyser); startMeter();

      procNode = audioCtx.createScriptProcessor(4096,1,1);
      srcNode.connect(procNode); procNode.connect(audioCtx.destination);

      ws = new WebSocket(`wss://api.openai.com/v1/realtime?model=${encodeURIComponent(model)}`, [
        'realtime',
        `openai-insecure-api-key.${apiKey}`,
        'openai-beta.realtime-v1'
      ]);

      ws.onopen=()=>{
        setConn(true); setStatus('üü¢ Conectado. Segure para falar', true); addMsg('system','Conectado ao OpenAI Realtime');
        ws.send(JSON.stringify({
          type:'session.update',
          session:{
            modalities:['text','audio'],
            instructions: systemPrompt,
            voice: selectedVoice,
            input_audio_format:'pcm16',
            output_audio_format:'pcm16',
            input_audio_transcription:{ model:'whisper-1' },
            turn_detection:{ type:'server_vad', threshold:0.5, prefix_padding_ms:300, silence_duration_ms:450 },
            temperature:0.8,
            max_response_output_tokens:2048
          }
        }));
      };
      ws.onmessage=onWSMessage;
      ws.onerror=(e)=>{ toast('WebSocket erro'); setStatus('‚ùå Erro WS', false, true) };
      ws.onclose=()=>{ disconnectWS() };

      procNode.onaudioprocess=(e)=>{
        if(!connected || !ws || ws.readyState!==WebSocket.OPEN || !outgoingEnabled) return;
        const input=e.inputBuffer.getChannelData(0);
        const pcm16=f32ToPCM16(input);
        const b64audio=b64.fromAB(pcm16.buffer);
        ws.send(JSON.stringify({ type:'input_audio_buffer.append', audio:b64audio }));
      };

    }catch(err){
      console.error(err);
      toast('Falha ao acessar microfone/conectar'); setStatus('‚ùå Permiss√£o ou conex√£o falhou', false, true);
    }
  }

  function disconnectWS(){
    setConn(false);
    if(ws){ try{ ws.close() }catch{} ws=null }
    if(procNode){ try{ procNode.disconnect() }catch{} procNode=null }
    if(stream){ try{ stream.getTracks().forEach(t=>t.stop()) }catch{} stream=null }
    if(audioCtx){ try{ audioCtx.close() }catch{} audioCtx=null }
    analyser=null; stopMeter();
    audioQueue=[]; playing=false; currentAssistantDiv=null;
    ptt.classList.remove('listening'); setStatus('‚è∏Ô∏è Desconectado');
    addMsg('system','Desconectado');
  }

  // ===================== UI events =====================
  window.addEventListener('load',()=>{
    const k=localStorage.getItem('openai_realtime_key'); if(k){ keyInput.value=k; apiKey=k; addMsg('system','‚úÖ API Key carregada') }
    addMsg('assistant','Ol√°! Configure sua chave e segure o bot√£o para iniciarmos sua sess√£o de cinema üé•üçø');
    setTimeout(()=> addMsg('system','Dica: ESC desconecta; Ctrl/Cmd + Enter alterna conex√£o'), 1200);
  });

  keyInput.addEventListener('change',e=>{
    apiKey=e.target.value.trim();
    if(apiKey){ localStorage.setItem('openai_realtime_key', apiKey); toast('API key salva localmente') }
  });
  voiceSel.addEventListener('change',e=>{
    if(connected){ toast('Desconecte para trocar de voz'); voiceSel.value=selectedVoice; return }
    selectedVoice=e.target.value; addMsg('system', `Voz: ${selectedVoice}`);
  });
  modelSel.addEventListener('change',e=>{
    if(connected){ toast('Desconecte para trocar de modelo'); modelSel.value=model; return }
    model=e.target.value; addMsg('system', `Modelo: ${model}`);
  });

  ptt.addEventListener('mousedown', async ()=>{
    if(!connected){ await connectWS() }
    if(!connected) return;
    outgoingEnabled=true; ptt.classList.add('listening'); setStatus('üé§ Gravando...', true);
  });
  ptt.addEventListener('mouseup', ()=>{
    if(!connected) return;
    outgoingEnabled=false; ptt.classList.remove('listening'); setStatus('ü§î Processando...', true);
    if(ws && ws.readyState===WebSocket.OPEN){
      ws.send(JSON.stringify({ type:'input_audio_buffer.commit' }));
      ws.send(JSON.stringify({ type:'response.create' }));
    }
  });
  ptt.addEventListener('touchstart', async (e)=>{ e.preventDefault(); if(!connected){ await connectWS() } if(!connected) return; outgoingEnabled=true; ptt.classList.add('listening'); setStatus('üé§ Gravando...', true); }, {passive:false});
  ptt.addEventListener('touchend', (e)=>{ e.preventDefault(); if(!connected) return; outgoingEnabled=false; ptt.classList.remove('listening'); setStatus('ü§î Processando...', true); if(ws && ws.readyState===WebSocket.OPEN){ ws.send(JSON.stringify({type:'input_audio_buffer.commit'})); ws.send(JSON.stringify({type:'response.create'})); } }, {passive:false});

  function sendText(){
    const txt=textInput.value.trim(); if(!txt) return;
    addMsg('user', txt); textInput.value='';
    if(!connected){ connectWS().then(()=> sendText()) ; return }
    ws.send(JSON.stringify({
      type:'conversation.item.create',
      item:{ type:'message', role:'user', content:[{ type:'input_text', text:txt }] }
    }));
    ws.send(JSON.stringify({ type:'response.create' }));
  }
  sendBtn.addEventListener('click', sendText);
  textInput.addEventListener('keydown',(e)=>{ if(e.key==='Enter') sendText() });

  suggs.addEventListener('click',(e)=>{
    const d=e.target.closest('.sugg'); if(!d) return;
    textInput.value=d.dataset.text; sendText();
  });

  copyBtn.addEventListener('click', async ()=>{
    if(!lastAssistantText){ toast('Nada para copiar'); return }
    await navigator.clipboard.writeText(lastAssistantText); toast('Resposta copiada!');
  });

  clearBtn.addEventListener('click',()=>{
    if(confirm('Limpar todo o hist√≥rico visual?')){ chat.innerHTML=''; addMsg('system','üßπ Hist√≥rico limpo') }
  });

  document.addEventListener('keydown',(e)=>{
    if(e.key==='Escape' && connected) disconnectWS();
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ connected ? disconnectWS() : connectWS() }
  });

  window.addEventListener('beforeunload',(e)=>{ if(connected){ e.preventDefault(); e.returnValue='Conex√£o ativa. Sair mesmo?'; }});
</script>
</body>
</html>