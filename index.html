<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CineTalk ‚Äî Convai Voice</title>
<meta name="theme-color" content="#0d0f14" />
<meta name="description" content="CineTalk - Conversa√ß√£o em tempo real com Convai API" />
<style>
  /* ====== Reset & Base ====== */
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg-0:#0b0d12; --bg-1:#0f1320; --bg-2:#131a2a;
    --ink:#eaf6ff; --muted:#9fb3c8; --brand:#6366f1; --brand-2:#4f46e5; --warn:#f59e0b; --err:#ef4444;
    --card:rgba(255,255,255,.04); --glass:rgba(255,255,255,.06);
    --bd:rgba(255,255,255,.08); --bd-2:rgba(255,255,255,.12);
    --radius:18px; --radius-sm:12px; --shadow:0 10px 40px rgba(0,0,0,.35);
  }
  html,body{height:100%}
  body{
    font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    background: radial-gradient(1200px 600px at 20% -10%, #1e1b4b, transparent),
                radial-gradient(1200px 800px at 120% 0%, #312e81, transparent),
                linear-gradient(135deg, #0b0d12 0%, #0f1320 50%, #131a2a 100%);
    color:var(--ink);
    line-height:1.6;
    padding:16px;
  }
  a{color:var(--brand);text-decoration:none}
  .container{max-width:1100px;margin:0 auto}

  /* ====== Header sticky ====== */
  .appbar{
    position:sticky;top:10px;z-index:20;
    display:flex;align-items:center;gap:14px;justify-content:space-between;
    padding:14px 18px;border-radius:16px;background:var(--glass);backdrop-filter: blur(12px);
    border:1px solid var(--bd);
    box-shadow:var(--shadow);
    margin-bottom:16px;
  }
  .brand{
    display:flex;align-items:center;gap:12px;
  }
  .brand h1{
    font-size:1.6rem;font-weight:800;
    background:linear-gradient(135deg, var(--brand), #818cf8);
    -webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;
    letter-spacing:0.2px;text-shadow:0 0 24px rgba(99,102,241,.35);
    white-space:nowrap;
  }
  .badge{font-size:.8rem;font-weight:700;padding:6px 12px;border-radius:999px;background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:0 4px 18px rgba(99,102,241,.45)}
  .conn{
    display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:999px;border:1px solid var(--bd);
    background:var(--card)
  }
  .dot{width:10px;height:10px;border-radius:50%;background:#6b7280;box-shadow:0 0 0 0 rgba(99,102,241,.0)}
  .dot.on{background:var(--brand);animation:dotPulse 2s infinite;box-shadow:0 0 10px var(--brand)}
  @keyframes dotPulse{0%,100%{opacity:1}50%{opacity:.5}}

  /* ====== Panels ====== */
  .panel{
    background:var(--card); border:1px solid var(--bd); border-radius:var(--radius); padding:20px; backdrop-filter: blur(8px); box-shadow:var(--shadow); margin-bottom:16px;
  }
  .panel h2{font-size:1.05rem;color:var(--muted);margin-bottom:12px;letter-spacing:.2px}

  .grid{display:grid; gap:12px}
  @media (min-width:900px){ .grid.cols-2{ grid-template-columns:1.2fr .8fr } }

  /* ====== Inputs ====== */
  .field{display:grid; gap:8px}
  .label{font-weight:700;color:var(--brand);font-size:.95rem}
  .input, .select{
    width:100%;padding:14px 14px;border-radius:12px;border:2px solid rgba(99,102,241,.28);
    background:rgba(255,255,255,.04);color:var(--ink);outline:none;transition:.25s;
    font-size:1rem
  }
  .input::placeholder{color:#98a9bd}
  .input:focus, .select:focus{border-color:var(--brand); box-shadow:0 0 16px rgba(99,102,241,.25)}
  .muted{color:var(--muted);font-size:.9rem}

  /* ====== Chat ====== */
  .chat{height:520px;overflow:auto;padding:14px;border-radius:16px;background:var(--glass);border:1px solid var(--bd)}
  .msg{margin:12px 0; padding:14px 16px; border-radius:14px; position:relative; box-shadow:0 6px 20px rgba(0,0,0,.25)}
  .msg.user{background:linear-gradient(135deg,#667eea,#764ba2); margin-left:15%; border-bottom-right-radius:6px}
  .msg.assistant{background:linear-gradient(135deg,var(--brand),var(--brand-2)); margin-right:15%; border-bottom-left-radius:6px}
  .msg.system{background:rgba(255,255,255,.08); color:#cbd5e1; font-style:italic; border-left:3px solid var(--brand); margin:10px 5%}
  .time{position:absolute; bottom:-18px; right:12px; font-size:.72rem; color:#90a4b8; opacity:.85}
  .sticky-tip{font-size:.95rem;color:#c7d6e8;margin-bottom:6px}

  /* ====== Controls ====== */
  .controls{
    display:flex; flex-direction:column; gap:12px; align-items:center; justify-content:center; padding:18px; border-radius:16px; background:var(--glass); border:1px solid var(--bd)
  }
  .ptt{
    width:140px;height:140px;border-radius:999px;border:none;cursor:pointer;font-size:2.2rem;
    display:flex;align-items:center;justify-content:center;transition: transform .16s;
    background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; box-shadow:0 14px 36px rgba(99,102,241,.45)
  }
  .ptt:hover{transform:scale(1.05)}
  .ptt.listening{background:linear-gradient(135deg,var(--warn),#f59e0b); animation:pttPulse 1.6s infinite}
  .ptt.stop{background:linear-gradient(135deg,#ef4444,#dc2626)}
  @keyframes pttPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.06)}}

  .status{
    text-align:center; font-weight:700; padding:12px 14px; border-radius:12px;
    background:rgba(255,255,255,.05); border:2px solid transparent; width:100%
  }
  .status.ok{background:rgba(99,102,241,.15); border-color:var(--brand)}
  .status.err{background:rgba(239,68,68,.15); border-color:#ef4444}

  .meter{height:56px; display:flex; gap:6px; align-items:flex-end; justify-content:center}
  .bar{width:6px; background:linear-gradient(to top, var(--brand), #818cf8); border-radius:3px; height:8px}

  /* ====== Footer actions ====== */
  .row{display:flex; gap:10px; flex-wrap:wrap}
  .btn{
    border:none; border-radius:10px; padding:12px 14px; font-weight:700; cursor:pointer;
    background:rgba(255,255,255,.06); color:#e8f3ff; border:1px solid var(--bd-2); transition:.2s
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.25)}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2)); border:none}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#dc2626);border:none}

  /* Toasts */
  .toast-wrap{position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:10px; z-index:99}
  .toast{
    background:rgba(14,18,26,.9); color:#e9f4ff; padding:12px 14px; border:1px solid var(--bd);
    border-radius:12px; box-shadow:var(--shadow); min-width:240px; font-size:.95rem
  }

  /* Suggestions */
  .suggestions{display:grid; gap:10px}
  .sugg{background:rgba(255,255,255,.05); border:1px solid var(--bd); padding:12px 14px; border-radius:12px; cursor:pointer}
  .sugg:hover{background:rgba(99,102,241,.12); border-color:var(--brand); transform:translateX(6px); transition:.18s}

  @media (max-width:780px){
    .grid.cols-2{grid-template-columns:1fr}
    .ptt{width:110px;height:110px}
    .row{flex-direction:column}
    .btn{width:100%}
  }
</style>
</head>
<body>
<div class="container">

  <!-- Top bar -->
  <div class="appbar">
    <div class="brand">
      <div style="font-size:1.6rem">üé¨</div>
      <h1>CineTalk</h1>
      <span class="badge">‚ö° Convai</span>
    </div>
    <div class="conn"><span class="dot" id="dot"></span><span id="connTxt">Desconectado</span></div>
  </div>

  <!-- Grid: chat | config -->
  <div class="grid cols-2">
    <!-- Left: chat -->
    <section class="panel">
      <h2>Chat</h2>
      <div class="sticky-tip">Dica: clique em "Iniciar" e fale naturalmente. O assistente detecta quando voc√™ terminou de falar üéôÔ∏è</div>
      <div id="chat" class="chat" aria-live="polite"></div>

      <div style="margin-top:12px" class="row">
        <input id="textInput" class="input" placeholder="Digite uma mensagem (Enter para enviar)" style="flex:1" />
        <button id="sendBtn" class="btn primary">Enviar</button>
        <button id="copyBtn" class="btn">Copiar</button>
        <button id="clearBtn" class="btn danger">Limpar</button>
      </div>
    </section>

    <!-- Right: config & controls -->
    <aside class="panel">
      <h2>Configura√ß√£o</h2>
      <div class="field">
        <label class="label" for="apiKey">üîë Convai API Key</label>
        <input id="apiKey" class="input" type="password" placeholder="Sua API key do Convai..." autocomplete="off" />
        <small class="muted">Obtenha em <a href="https://convai.com/pipeline/dashboard" target="_blank" style="color:var(--brand)">convai.com/pipeline/dashboard</a></small>
      </div>

      <div class="field" style="margin-top:10px">
        <label class="label" for="charId">üë§ Character ID</label>
        <input id="charId" class="input" type="text" placeholder="ID do personagem..." />
        <small class="muted">ID do character configurado no Convai dashboard</small>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Controles de Voz</h2>
        <div class="controls">
          <button id="ptt" class="ptt" title="Clique para iniciar/parar">üé§</button>
          <div id="status" class="status">Configure API Key e Character ID para come√ßar</div>
          <div id="meter" class="meter" aria-hidden="true">
            <div class="bar"></div><div class="bar"></div><div class="bar"></div>
            <div class="bar"></div><div class="bar"></div><div class="bar"></div><div class="bar"></div>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h2>Perguntas Sugeridas</h2>
        <div class="suggestions" id="suggs">
          <div class="sugg" data-text="Quais s√£o os melhores filmes de fic√ß√£o cient√≠fica dos anos 80?">üöÄ Sci-fi anos 80</div>
          <div class="sugg" data-text="Me recomende s√©ries de suspense na Netflix">üîç Suspense na Netflix</div>
          <div class="sugg" data-text="Conte sobre a filmografia do Quentin Tarantino">üé¨ Filmografia Tarantino</div>
          <div class="sugg" data-text="Quais s√©ries s√£o boas para assistir em fam√≠lia?">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ S√©ries para fam√≠lia</div>
          <div class="sugg" data-text="Explique o que √© cinema noir">üïµÔ∏è O que √© cinema noir</div>
          <div class="sugg" data-text="Recomende anima√ß√µes premiadas recentes">üé® Anima√ß√µes premiadas</div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Info -->
  <section class="panel">
    <h2>‚ÑπÔ∏è Como funciona</h2>
    <p class="muted">
      Este app usa a <strong>Convai API</strong> para conversa√ß√£o de voz em tempo real com personagens de IA.
      Configure um character no dashboard do Convai, obtenha sua API key e Character ID, e comece a conversar sobre cinema! üé•
    </p>
  </section>

</div>

<!-- Toasts -->
<div id="toasts" class="toast-wrap"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
<script>
  // ===================== State =====================
  const el = (id)=>document.getElementById(id);
  const chat = el('chat');
  const statusEl = el('status');
  const dot = el('dot');
  const connTxt = el('connTxt');
  const ptt = el('ptt');
  const apiKeyInput = el('apiKey');
  const charIdInput = el('charId');
  const textInput = el('textInput');
  const sendBtn = el('sendBtn');
  const clearBtn = el('clearBtn');
  const copyBtn = el('copyBtn');
  const toasts = el('toasts');
  const meter = el('meter');
  const suggs = el('suggs');

  let apiKey = '';
  let characterId = '';
  let sessionId = '';
  let connected = false;
  let audioCtx = null;
  let stream = null;
  let analyser = null;
  let rafId = null;
  let mediaRecorder = null;
  let audioChunks = [];
  let lastAssistantText = '';
  let isRecording = false;

  const CONVAI_API_BASE = 'https://api.convai.com';

  // ===================== Helpers =====================
  const toast = (msg) => {
    const d = document.createElement('div');
    d.className = 'toast';
    d.textContent = msg;
    toasts.appendChild(d);
    setTimeout(() => {
      d.style.opacity = '0';
      setTimeout(() => d.remove(), 300);
    }, 2500);
  };

  const stamp = () => new Date().toLocaleTimeString();

  function addMsg(role, text) {
    const m = document.createElement('div');
    m.className = `msg ${role}`;
    m.textContent = text;
    const t = document.createElement('div');
    t.className = 'time';
    t.textContent = stamp();
    m.appendChild(t);
    chat.appendChild(m);
    chat.scrollTop = chat.scrollHeight;
    if (role === 'assistant') lastAssistantText = text;
    const all = chat.querySelectorAll('.msg');
    if (all.length > 60) all[0].remove();
    return m;
  }

  function setStatus(txt, ok = false, err = false) {
    statusEl.textContent = txt;
    statusEl.className = 'status' + (ok ? ' ok' : '') + (err ? ' err' : '');
  }

  function setConn(on) {
    connected = on;
    connTxt.textContent = on ? 'Conectado' : 'Desconectado';
    dot.classList.toggle('on', on);
  }

  // ===================== Audio visuals =====================
  function startMeter() {
    if (!analyser) return;
    const bars = [...meter.querySelectorAll('.bar')];
    function loop() {
      const arr = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(arr);
      const step = Math.floor(arr.length / bars.length);
      bars.forEach((b, i) => {
        const slice = arr.slice(i * step, (i + 1) * step);
        const avg = slice.reduce((a, c) => a + c, 0) / slice.length || 0;
        const h = Math.max(6, Math.min(52, (avg / 255) * 56));
        b.style.height = `${h}px`;
      });
      rafId = requestAnimationFrame(loop);
    }
    loop();
  }

  function stopMeter() {
    if (rafId) {
      cancelAnimationFrame(rafId);
      rafId = null;
    }
  }

  // ===================== Convai API Functions =====================
  async function startSession() {
    if (!apiKey || !characterId) {
      toast('Informe API Key e Character ID');
      return false;
    }

    try {
      setStatus('üîÑ Iniciando sess√£o...');
      
      // Criar sess√£o
      const response = await axios.post(
        `${CONVAI_API_BASE}/character/getResponse`,
        {
          userText: 'Ol√°!',
          charID: characterId,
          sessionID: sessionId || '-1',
          voiceResponse: true
        },
        {
          headers: {
            'CONVAI-API-KEY': apiKey,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data && response.data.sessionID) {
        sessionId = response.data.sessionID;
        setConn(true);
        setStatus('üü¢ Conectado - Fale naturalmente', true);
        addMsg('system', 'Sess√£o iniciada com Convai');
        
        if (response.data.text) {
          addMsg('assistant', response.data.text);
        }

        // Play audio if available
        if (response.data.audio) {
          playBase64Audio(response.data.audio);
        }

        return true;
      } else {
        throw new Error('Resposta inv√°lida da API');
      }
    } catch (err) {
      console.error('Erro ao iniciar sess√£o:', err);
      toast('Erro ao conectar: ' + (err.response?.data?.message || err.message));
      setStatus('‚ùå Erro na conex√£o', false, true);
      return false;
    }
  }

  async function sendTextToConvai(text) {
    if (!sessionId) {
      const started = await startSession();
      if (!started) return;
    }

    try {
      setStatus('ü§î Processando...', true);
      
      const response = await axios.post(
        `${CONVAI_API_BASE}/character/getResponse`,
        {
          userText: text,
          charID: characterId,
          sessionID: sessionId,
          voiceResponse: true
        },
        {
          headers: {
            'CONVAI-API-KEY': apiKey,
            'Content-Type': 'application/json'
          }
        }
      );

      if (response.data) {
        if (response.data.text) {
          addMsg('assistant', response.data.text);
        }

        if (response.data.audio) {
          playBase64Audio(response.data.audio);
        }
        
        setStatus('üé§ Pronto para pr√≥xima pergunta', true);
      }
    } catch (err) {
      console.error('Erro ao enviar texto:', err);
      toast('Erro ao processar: ' + (err.response?.data?.message || err.message));
      setStatus('‚ùå Erro', false, true);
    }
  }

  async function sendAudioToConvai(audioBlob) {
    if (!sessionId) {
      const started = await startSession();
      if (!started) return;
    }

    try {
      setStatus('ü§î Processando √°udio...', true);

      const formData = new FormData();
      formData.append('userText', '');
      formData.append('charID', characterId);
      formData.append('sessionID', sessionId);
      formData.append('voiceResponse', 'true');
      formData.append('audio', audioBlob, 'audio.wav');

      const response = await axios.post(
        `${CONVAI_API_BASE}/character/getResponse`,
        formData,
        {
          headers: {
            'CONVAI-API-KEY': apiKey,
            'Content-Type': 'multipart/form-data'
          }
        }
      );

      if (response.data) {
        if (response.data.userQuery) {
          addMsg('user', response.data.userQuery);
        }

        if (response.data.text) {
          addMsg('assistant', response.data.text);
        }

        if (response.data.audio) {
          playBase64Audio(response.data.audio);
        }
        
        setStatus('üé§ Pronto para pr√≥xima pergunta', true);
      }
    } catch (err) {
      console.error('Erro ao enviar √°udio:', err);
      toast('Erro ao processar √°udio: ' + (err.response?.data?.message || err.message));
      setStatus('‚ùå Erro', false, true);
    }
  }

  function playBase64Audio(base64Audio) {
    try {
      const audio = new Audio('data:audio/wav;base64,' + base64Audio);
      audio.play().catch(e => console.error('Erro ao tocar √°udio:', e));
      setStatus('üîä Assistente falando...', true);
      
      audio.onended = () => {
        setStatus('üé§ Pronto para pr√≥xima pergunta', true);
      };
    } catch (err) {
      console.error('Erro ao reproduzir √°udio:', err);
    }
  }

  // ===================== Audio Recording =====================
  async function startRecording() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      });

      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const srcNode = audioCtx.createMediaStreamSource(stream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 1024;
      srcNode.connect(analyser);
      startMeter();

      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = (e) => {
        if (e.data.size > 0) {
          audioChunks.push(e.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        if (audioBlob.size > 1000) { // Only send if there's actual audio
          await sendAudioToConvai(audioBlob);
        }
        audioChunks = [];
      };

      mediaRecorder.start();
      isRecording = true;
      ptt.classList.add('listening');
      setStatus('üé§ Gravando... (clique novamente para parar)', true);
      
    } catch (err) {
      console.error('Erro ao acessar microfone:', err);
      toast('Erro ao acessar microfone');
      setStatus('‚ùå Permiss√£o negada', false, true);
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
    }
    
    if (stream) {
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    
    if (audioCtx) {
      audioCtx.close();
      audioCtx = null;
    }
    
    stopMeter();
    isRecording = false;
    ptt.classList.remove('listening');
  }

  function disconnect() {
    stopRecording();
    setConn(false);
    sessionId = '';
    setStatus('‚è∏Ô∏è Desconectado');
    addMsg('system', 'Sess√£o encerrada');
  }

  // ===================== UI Events =====================
  window.addEventListener('load', () => {
    const savedApiKey = localStorage.getItem('convai_api_key');
    const savedCharId = localStorage.getItem('convai_char_id');
    
    if (savedApiKey) {
      apiKeyInput.value = savedApiKey;
      apiKey = savedApiKey;
      addMsg('system', '‚úÖ API Key carregada');
    }
    
    if (savedCharId) {
      charIdInput.value = savedCharId;
      characterId = savedCharId;
      addMsg('system', '‚úÖ Character ID carregado');
    }
    
    addMsg('assistant', 'Ol√°! Configure sua API Key e Character ID do Convai para come√ßarmos a conversar sobre cinema üé¨üçø');
  });

  apiKeyInput.addEventListener('change', (e) => {
    apiKey = e.target.value.trim();
    if (apiKey) {
      localStorage.setItem('convai_api_key', apiKey);
      toast('API Key salva');
    }
  });

  charIdInput.addEventListener('change', (e) => {
    characterId = e.target.value.trim();
    if (characterId) {
      localStorage.setItem('convai_char_id', characterId);
      toast('Character ID salvo');
    }
  });

  ptt.addEventListener('click', async () => {
    if (!connected) {
      const started = await startSession();
      if (!started) return;
    }

    if (isRecording) {
      stopRecording();
    } else {
      await startRecording();
    }
  });

  function sendText() {
    const txt = textInput.value.trim();
    if (!txt) return;
    
    addMsg('user', txt);
    textInput.value = '';
    sendTextToConvai(txt);
  }

  sendBtn.addEventListener('click', sendText);
  textInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendText();
  });

  suggs.addEventListener('click', (e) => {
    const d = e.target.closest('.sugg');
    if (!d) return;
    textInput.value = d.dataset.text;
    sendText();
  });

  copyBtn.addEventListener('click', async () => {
    if (!lastAssistantText) {
      toast('Nada para copiar');
      return;
    }
    await navigator.clipboard.writeText(lastAssistantText);
    toast('Resposta copiada!');
  });

  clearBtn.addEventListener('click', () => {
    if (confirm('Limpar todo o hist√≥rico visual?')) {
      chat.innerHTML = '';
      addMsg('system', 'üßπ Hist√≥rico limpo');
    }
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && connected) disconnect();
  });

  window.addEventListener('beforeunload', (e) => {
    if (connected) {
      e.preventDefault();
      e.returnValue = 'Sess√£o ativa. Sair mesmo?';
    }
  });
</script>
</body>
</html>